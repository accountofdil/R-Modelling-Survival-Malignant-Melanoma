---
output:
  pdf_document:
    latex_engine: xelatex
    fig_caption: true
fontsize: 10pt
knitr:
  opts_chunk:
    warning: false
    message: false
header-includes: |
  \pagenumbering{gobble}
---

\noindent\LARGE \textbf{Modelling Survival from Malignant Melanoma}

\vspace{0.5cm}

\noindent\small \textbf{Dilan Patel} (Student ID: \textbf{240893718}) \ | \texttt{ah24020@qmul.ac.uk} | MTH7020P - Biostatistics and Medical Statistics

```{r echo = FALSE, message = FALSE, warning = FALSE}
library(stats)
library(knitr)
library(ggplot2)
library(magick)
library(forecast)
library(fpp2)
library(GGally)
library(gridExtra)
library(knitr)
library(patchwork)
library(BSDA)
library(dplyr)
library(GLMsData)
library(MedDataSets)
library(NHSRdatasets)
library(medicaldata)
library(predictmeans)
library(tidyverse) 
library(MASS)
library(nnet)
library(survival)
library(VGAM) 
library(mlbench)
library(ResourceSelection)
library(pROC)
library(caret)
library(datasets) 
library(foreign)
library(brant)
library(svyVGAM)
library(pscl)
library(tibble)
library(cards)
library(cardx)
library(lubridate)
library(ggsurvfit)
library(gtsummary)
library(tidycmprsk)
library(survminer)
library(pwr)
library(blockrand)
library(randomizeR)
```

```{r echo = FALSE}
data(package = "MedDataSets")
library(MedDataSets)
view(Melanoma_df)
```

## 1. Introduction & Research Question

This analysis explores the modelling of survival from malignant melanoma, using the `Melanoma_df` dataset from `MedDataSets`. The hypothesis is whether survival probabilities, from melanoma, decrease over time, accounting for predictors. Statistical approaches to quantifying survival from melanoma are documented in academic literature. Florell et. al (2005) deployed a multivariate logistic regression analysis to evaluate prognostic and survival statistics of the familial melanoma population from a Utah database. Pollack et. al (2011) calculated unadjusted cause-specific survival for 68,495 primary melanoma cases, diagnosed from 1992 to 2005. Through multivariate analysis, Pollack et. al (2011) found that 5-year melanoma survival increased from 87.7% to 90.1%, for diagnosed cases between 1992-1995 compared to 1999-2001. Jalving et. al (2024) used a Cox proportional hazards model to investigate factors associated with progression-free survival from melanoma, a study that included 2490 patients with advanced cases. Lastly, Karponis et. al (2025) assessed incidence and mortality trends for melanomia in situ (MIS) and malignant melanoma (MM), in England, between 2001 and 2020. Here, Karponis et. al (2025) utilised join-point regression analysis, to calculate average percentage change in mortality, alongisde age-standardised incidence of the condition. 

## 2. Exploratory Data Analysis & Preprocessing

The original dataset contains information about the survival rates of patients diagnosed with malignant melanoma, and involves clinical factors affecting prognosis. Table 1 outlines descriptions of the variables found in `Melanoma_df`.

```{r echo = FALSE}

library(knitr)

description_table <- data.frame(
  Variable = c("time", "status", "sex", "age", "year", "thickness", "ulcer"),
  Description = c(
    "Survival time of the patients",
    "Status of patient at study end",
    "Sex of the patient",
    "Age of the patient at diagnosis",
    "Year of diagnosis",
    "Thickness of the melanoma",
    "Presence of ulceration"
 ),
  Measures = c(
    "Months",
    "1 - Died from Melanoma, 2 - Alive, 3 - Died from Other Causes",
    "1 - Male, 0 - Female",
    "Years",
    "",
    "Millimetres",
    "1 - Ulceration, 0 - No Ulceration"
  ),
  row.names = NULL
)

kable(description_table, caption = "**Variable Descriptions for Melanoma Dataset**")
```

Two stages of exploratory data analysis (EDA) were conducted. In the first stage, bar plots, scatter plots, box plots, and histograms, were computed for applicable variables, to assess distributions and spread. 


```{r echo = FALSE, message = FALSE, warning = FALSE, fig.width = 8, fig.height = 3}

barplot_sex <- ggplot(Melanoma_df, aes(x = factor(sex, levels = c(0, 1), labels = c("Female", "Male")))) +
  geom_bar(fill = "grey") +
  geom_text(stat = "count", aes(label = ..count..), vjust = 1.5, color = "black") +
  labs(title = "Figure 1: Frequency Bar Plot for Patient Sex", x = "Patient Sex", y = "Frequency") +
  theme(
    plot.title = element_text(size = 10),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 8)
  )
  
barplot_status <- ggplot(Melanoma_df, aes(x = factor(status, levels = c(1, 2, 3), 
                                          labels = c("Died from Melanoma", "Alive", "Died from Other Causes")))) +
  geom_bar(fill = "grey") +
  geom_text(stat = "count", aes(label = ..count..), vjust = 1.5, color = "black") +
  labs(title = "Figure 2: Frequency Bar Plot for Patient Status", x = "Patient Status", y = "Frequency") +
  theme(
    plot.title = element_text(size = 10),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 8)
  )

grid.arrange(barplot_sex, barplot_status, ncol = 2)

```

Box plots for `time`, `age` and `thickness` revealed the potential presence of outliers. Therefore, observations (for these variables), calculated as $Q_3 + 1.5 \times \text{IQR}$ and $Q_1 - 1.5 \times \text{IQR}$, were removed. In other words, observations quantified as 1.5 times the IQR above quantile 3 (upper bound) or 1.5 times the IQR below quantile 1 (lower bound).


```{r echo = FALSE, message = FALSE, warning = FALSE, fig.width = 8, fig.height = 3} 

boxplot_age <- ggplot(Melanoma_df, aes(y = age)) +
  geom_boxplot() +
  labs(title = "Figure 3: Boxplot for Patient Age", y = "Patient Age") +
  theme(
    plot.title = element_text(size = 10),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 8)
  )

boxplot_thickness <- ggplot(Melanoma_df, aes(y = thickness)) +
  geom_boxplot() +
  labs(title = "Figure 4: Boxplot for Thickness of Melanoma", y = "Thickness of Melanoma") +
  theme(
    plot.title = element_text(size = 10),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 8)
  )

grid.arrange(boxplot_age, boxplot_thickness, ncol = 2)

```

Moreover, time-to-event data involves censoring. Censoring must differentiate between event times (full-time information) and censoring times (partial-time information). The method produces a summary statistic that captures both binary and time portions. Censoring occurs when the time to the event (death from melanoma) is not observed for a subject. Therefore, observations classed as `Died from Melanoma` were maintained at a value of 1, whilst all others (`Alive` or `Died from Other Causes`) were changed to 0. 

The cleaned dataset consisted of 190 observations of the same 7 variables. Moreover, for the second stage of EDA, summary statistics, and Pearson correlation coefficients in matrix format, were computed. Also, scatter plots (`age` versus `time` and `thickness` and `time`) visualised weak correlations between variables (see figures 5 and 6).


```{r echo = FALSE}

summarystatistics <- data.frame(
  Variable = c("time", "status", "sex", "age", "year", "thickness", "ulcer"),
  Minimum = c(10, 0.0000, 0.0000, 12.00, 1964, 0.100, 0.0000),
  `1st Quartile` = c(1561, 0.0000, 0.0000, 42.00, 1968, 0.970, 0.0000),
  Median = c(2009, 0.0000, 0.0000, 54.00, 1971, 1.620, 0.0000),
  Mean = c(2166, 0.2737, 0.3789, 52.01, 1970, 2.325, 0.4211),
  `3rd Quartile` = c(3042, 1.0000, 1.0000, 64.00, 1972, 3.220, 1.0000),
  Maximum = c(4926, 1.0000, 1.0000, 95.00, 1977, 7.730, 1.0000),
  check.names = FALSE
)

kable(summarystatistics, 
      caption = "**Summary Statistics of Melanoma Dataset**", 
      align = rep("l", ncol(summarystatistics)))

```

```{r echo = FALSE}

correlationmatrix <- data.frame(
  time       = c(1.00000000, -0.48922890, -0.122601610, -0.25627727, -0.526147039, -0.20735154, -0.24977227),
  status     = c(-0.48922890, 1.00000000, 0.153173174, 0.08241307, -0.192045498, 0.34901890, 0.36115975),
  sex        = c(-0.122601610, 0.153173174, 1.00000000, 0.06760730, -0.009873975, 0.24593223, 0.14687745),
  age        = c(-0.25627727, 0.08241307, 0.067607298, 1.00000000, 0.200797005, 0.13704009, 0.10205187),
  year       = c(-0.526147039, -0.192045498, -0.009873975, 0.200797005, 1.00000000, -0.07816625, -0.01931402),
  thickness  = c(-0.20735154, 0.34901890, 0.24593223, 0.13704009, -0.07816625, 1.00000000, 0.52805186),
  ulcer      = c(-0.24977227, 0.36115975, 0.14687745, 0.10205187, -0.01931402, 0.52805186, 1.00000000),
  row.names = c("time", "status", "sex", "age", "year", "thickness", "ulcer")
)

kable(correlationmatrix, 
      caption = "**Correlation Matrix for Melanoma Dataset**", 
      align = rep("l", ncol(correlationmatrix)))

```

```{r echo = FALSE}

q3time <- quantile(Melanoma_df$time, 0.75)
q1time <- quantile(Melanoma_df$time, 0.25)
iqrtime <- q3time - q1time
upperboundtime <- q3time + 1.5*iqrtime
outliers_uppertime <- Melanoma_df$time[Melanoma_df$time > upperboundtime]
lowerboundtime <- q1time - 1.5*iqrtime
outliers_lowertime <- Melanoma_df$time[Melanoma_df$time < lowerboundtime]
Melanoma_df_nooutliers1 <- subset(Melanoma_df, Melanoma_df$time > (q1time - 1.5*iqrtime) & Melanoma_df$time < (q3time + 1.5*iqrtime))

q3age <- quantile(Melanoma_df_nooutliers1$age, 0.75)
q1age <- quantile(Melanoma_df_nooutliers1$age, 0.25)
iqrage <- q3age - q1age
upperboundage <- q3age + 1.5*iqrage
outliers_upperage <- Melanoma_df$age[Melanoma_df_nooutliers1$age > upperboundage]
lowerboundage <- q1age - 1.5*iqrage
outliers_lowerage <- Melanoma_df_nooutliers1$age[Melanoma_df_nooutliers1$age < lowerboundage]
Melanoma_df_nooutliers2 <- subset(Melanoma_df_nooutliers1, Melanoma_df_nooutliers1$age > (q1age - 1.5*iqrage) & Melanoma_df_nooutliers1$age < (q3age + 1.5*iqrage))

q3thickness <- quantile(Melanoma_df_nooutliers2$thickness, 0.75)
q1thickness <- quantile(Melanoma_df_nooutliers2$thickness, 0.25)
iqrthickness <- q3thickness - q1thickness
upperboundthickness <- q3thickness + 1.5*iqrthickness
outliers_upperthickness <- Melanoma_df_nooutliers2$thickness[Melanoma_df_nooutliers2$thickness > upperboundthickness]
lowerboundthickness <- q1thickness - 1.5*iqrthickness
outliers_lowerthickness <- Melanoma_df_nooutliers2$thickness[Melanoma_df_nooutliers2$thickness < lowerboundthickness]
Melanoma_df_cleaned <- subset(Melanoma_df_nooutliers2, Melanoma_df_nooutliers2$thickness > (q1thickness - 1.5*iqrthickness) & Melanoma_df_nooutliers2$thickness < (q3thickness + 1.5*iqrthickness))

Melanoma_df_cleaned$status <- ifelse(Melanoma_df_cleaned$status == 1, 1, 0)
```

```{r echo = FALSE, message = FALSE, warning = FALSE, fig.width = 8, fig.height = 3} 

scatterplot_age <- ggplot(Melanoma_df_cleaned, aes(x = age, y = time)) +
  geom_point(alpha = 0.7) +
  labs(title = "Figure 5: Scatter Plot (Age vs. Time)", x = "Age of Patient", y = "Survival Time of Patient") +
  theme(
    plot.title = element_text(size = 10),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 8)
  )

scatterplot_thickness <- ggplot(Melanoma_df_cleaned, aes(x = thickness, y = time)) +
  geom_point(alpha = 0.7) +
  labs(title = "Figure 6: Scatter Plot (Thickness vs. Time)", x = "Thickness of Melanoma", y = "Survival Time of Patient") +
  theme(
    plot.title = element_text(size = 10),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 8)
  )

grid.arrange(scatterplot_age, scatterplot_thickness, ncol = 2)

```

## 3. Methodology

### 3.1. Log-Rank Test

Using the log-rank test, survival times were compared across `sex` (males and females) alongisde `ulcer` (presence of ulceration and no presence of ulceration). The log-rank test compares two or more independent survival curves, finding applications to categorical variables such as `sex` and `ulcer`. As a non-parametric test, it makes zero assumptions about the distributional form of the survival data, and constructs 2 × 2 tables for each distinct uncensored time from the entire (pooled) sample. The null hypothesis states there is no difference in the survival experiences between the two (or more) groups. The log-rank (chi-squared) test statistic, $\chi^2$, is obtained by summing the number of observed and expected events, alongside the variances for one of two groups, over all distinct uncensored times.

$$\chi^2 = \frac{\left[ \sum_i \left( d_{i1} - E(d_{i1}) \right) \right]^2}{\sum_i \text{Var}(d_{i1})} = \frac{(O_1 - E_1)^2}{V_1}$$

### 3.2. Cox Proportional Hazards Regression Model

The Cox proportional hazards (PH) regression model analyses the effects of multiple covariates on survival. There are important assumptions made regarding the model. First, non-informative censoring and independent survival times are assumed. Second, the effects of time-independent covariates, on hazard, are constant over time. Third, the hazards are assumed to be proportional. The model specification for $i$th subject is outlined below, where $h_0(t)$ is the baseline or underlying hazard function, modified (multiplicatively) by effects of time-dependent covariates ($\mathbf{x}_i$) through an exponential function. Regression parameters linked to respective covariates are denoted by $\boldsymbol{\beta}$.
$$h_i(t) = h(t \mid \mathbf{x}_i) = h_0(t) \exp(\boldsymbol{\beta}^T \mathbf{x}_i)$$

Three Cox proportional hazards models were fitted to the data. The first model contained `sex` and `ulcer`. The second model contained `sex`, `ulcer` and `age`. The third model contained `sex`, `ulcer`, `age` and `thickness`. In addition, a Likelihood Ratio Test (LRT) was performed to compare these three nested Cox PH models.  

Let data correspond to a set of $n$ independent observations, denoted as $\{(y_i, \delta_i, \mathbf{x}_i); i = 1, \dots, n\}$. The likelihood on the observed data, conditional on the covariates, is given by:
$$L(\boldsymbol{\beta}, h_0(.)) = \prod_{i=1}^{n} h(y_i \mid \mathbf{x}_i)^{\delta_i} S(y_i \mid \mathbf{x}_i)$$
Estimation proceeds by maximising the above equation for $L_1(\boldsymbol{\beta})$, with respect to $\boldsymbol{\beta}$, to obtain the maximum partial likelihood estimates $\hat{\boldsymbol{\beta}}_{PL}$. Subsequently, the log partial likelihood is denoted by:
$$l_{PL}(\boldsymbol{\beta}) = \log L_1(\boldsymbol{\beta}) = \sum_{i=1}^{n} \delta_i \left\{ \boldsymbol{\beta}^T \mathbf{x}_i - \log \left( \sum_{j \in R(y_i)} e^{\boldsymbol{\beta}^T \mathbf{x}_j} \right) \right\}$$

### 3.3. Proportional Hazards Assumption

The proportional hazards (PH) assumption implies that the ratio of hazard functions, corresponding to any two values of $\mathbf{x}$, is constant over (and independent of) time. For two subjects $i$ and $j$, and the Cox model, the proportional hazards assumption of independence is outlined, in mathematical terms, as:
$$\frac{h(t \mid \mathbf{x}_i)}{h(t \mid \mathbf{x}_j)} = \exp\left(\boldsymbol{\beta}^T(\mathbf{x}_i - \mathbf{x}_j)\right)$$
The PH assumption is satisfied when logarithms of hazard functions, for two groups, are parallel. Upon selecting the best fitted model, a Schoenfeld Residual Test was conducted to check whether the PH assumption had been met. Here, the PH assumption was assessed based on the correlation between the rescaled Schoenfeld residuals, and some transformation of time. The null hypothesis of the Schoenfeld Residual Test states that the covariate's effect (hazard ratio) is constant over time, meaning that the PH assumption holds. One rejects the null hypothesis if $p < 0.05$.

## 4. Results & Discussion

### 4.1. Log-Rank Test

For the log-rank test for `sex`, the p-value was 0.02. For `ulcer`, the p-value was 1e-07. Both p-values warrant the rejection of the null hypothesis, suggesting that there are significant differences in the survival experiences between respective groups found in both categorical variables. 

```{r echo = FALSE}

surv_object <- Surv(time = Melanoma_df_cleaned$time, event = Melanoma_df_cleaned$status == 1)
log_rank_testsex <- survdiff(surv_object ~ sex, data = Melanoma_df_cleaned)
log_rank_testulcer <- survdiff(surv_object ~ ulcer, data = Melanoma_df_cleaned)

```

```{r echo = FALSE, results = 'asis', message = FALSE}
library(knitr)

log_rank_resultssex <- data.frame(
  Group = c("Female", "Male"),
  N = c(118, 72),
  Observed = c(26, 26),
  Expected = c(33.9, 18.1),
  `$(O - E)^2 / E$` = c(1.85, 3.48),
  `$(O - E)^2 / V$` = c(5.34, 5.34),
  check.names = FALSE
)

kable(log_rank_resultssex,
      caption = "**Log-Rank Test Results for Sex**",
      align = rep("l", ncol(log_rank_resultssex)))
```

```{r echo = FALSE, results = 'asis', message = FALSE}
library(knitr)

log_rank_resultsulcer <- data.frame(
  Group = c("No Ulceration", "Ulceration"),
  N = c(110, 80),
  Observed = c(15, 37),
  Expected = c(33.3, 18.7),
  `$(O - E)^2 / E$` = c(10.1, 18.0),
  `$(O - E)^2 / V$` = c(28.2, 28.2),
  check.names = FALSE
)

kable(log_rank_resultsulcer,
      caption = "**Log-Rank Test Results for Ulceration**",
      align = rep("l", ncol(log_rank_resultsulcer)))
```


### 4.2. Cox Proportional Hazards Regression Model

For `fit3`, `ulcer` is significant; a ratio of 2.999 suggests that chances of hazard increase by 299.9% if ulceration is present. Hence, for `fit3`, patients found to have ulceration are at higher risk of experiencing the hazardous event (death from melanoma) compared to those without ulceration. Moreover, for `fit3`, `thickness` is also significant ($p = 0.008$); a ratio of 1.2295 suggests that chances of hazard increase by 22.95% for each additional millimeter of melanoma thickness. Hence, for `fit3`, patients with greater thickness of melanoma tend to have a higher risk of experiencing the hazardous event (death from melanoma).

```{r echo = FALSE, message = FALSE}
fit1 <- coxph(Surv(time = Melanoma_df_cleaned$time, 
                   event = Melanoma_df_cleaned$status) ~ sex + ulcer, 
              data = Melanoma_df_cleaned)

fit2 <- coxph(Surv(time = Melanoma_df_cleaned$time, 
                   event = Melanoma_df_cleaned$status) ~ sex + ulcer + age, 
              data = Melanoma_df_cleaned)

fit3 <- coxph(Surv(time = Melanoma_df_cleaned$time, 
                   event = Melanoma_df_cleaned$status) ~ sex + ulcer + age + thickness, 
              data = Melanoma_df_cleaned)
```

```{r echo = FALSE, message = FALSE}

anova_results <- data.frame(
  Model = c("Model 1: ~ sex + ulcer", 
            "Model 2: ~ sex + ulcer + age", 
            "Model 3: ~ sex + ulcer + age + thickness"),
  `Log Likelihood` = c(-238.75, -237.92, -234.62),
  `Chi-Squared Statistic` = c(NA, 1.6646, 6.5998),
  `p-Value` = c(NA, 0.1970, 0.0102),
  check.names = FALSE
)

kable(anova_results,
      caption = "**Analysis of Deviance (Likelihood Ratio Test)**",
      align = "l")
```

Results from the LRT indicate that `fit3` is most optimal, which contains all predictors apart from `year`. This is because the p-value equals 0.0102, meaning that the null hypothesis, which states that a simpler model of fewer parameters is adequate, is rejected in favour of support for a more complex model.  

```{r echo = FALSE, message = FALSE}
fit3 <- coxph(Surv(time = Melanoma_df_cleaned$time, 
                   event = Melanoma_df_cleaned$status) ~ sex + ulcer + age + thickness, 
              data = Melanoma_df_cleaned)
```

```{r echo = FALSE, message = FALSE}
selectedmodel_results <- data.frame(
  Variable = c("sex", "ulcer", "age", "thickness"),
  Coefficient = c(0.295389, 1.098405, 0.012468, 0.206624),
  `Exponential` = c(1.343648, 2.999378, 1.012546, 1.229520),
  `Standard Error` = c(0.291519, 0.333818, 0.008561, 0.077914),
  `Pr(>|z|)` = c(0.311, 0.001, 0.145, 0.008),
  `Lower 95% CI` = c(0.7588, 1.5591, 0.9957, 1.0554),
  `Upper 95% CI` = c(2.379, 5.770, 1.030, 1.432),
  check.names = FALSE
)

kable(selectedmodel_results,
      caption = "**Selected Cox Proportional Hazards Model**",
      align = rep("l", ncol(selectedmodel_results)))
```

### 4.3. Proportional Hazards Assumption

```{r echo = FALSE, message = FALSE}

schoenfeld_results <- data.frame(
  Variable = c("sex", "ulcer", "age", "thickness", "Global"),
  `Chi-Squared Statistic` = c(0.707, 2.416, 1.534, 7.412, 8.639),
  `p-Value` = c(0.4005, 0.1201, 0.2155, 0.0065, 0.0708),
  check.names = FALSE
)

kable(schoenfeld_results,
      caption = "**Schoenfeld Residuals Test for Selected Model**",
      align = "l")
```

The Schoenfeld Residuals Test found 1 variable (`thickness`) in violation of the proportional hazards assumption, with a p-value of 0.0065. However, due to the global p-value being 0.0708, it can be stated that the chosen model passes the Schoenfeld Residuals Test, and supports the proportional hazards assumption. 

### 4.4. Hazard Ratios & Survival Probabilities

To initialise prediction, two hypothetical individuals were considered. The first individual was assumed to be a 35 year old (`age = 35`) female (`sex = 0`), with presence of ulceration (`ulcer = 1`), and melanoma thickness of 4.5 millimeters (`thickness`). The second individual was assumed to be a 52 year old (`age = 52`) male (`sex = 1`), with no presence of ulceration (`ulcer = 0`), and melanoma thickness of 6.1 millimeters (`thickness`). Survival curves for both individuals were computed using the Cox model. Survival probabilities at time (month) 2166 were extracted for each individual; the choice of 2166 had been based on the average from the entire dataset. 

For these scenarios, the number of individuals at risk (at month 2166) was `n.risk = 77`, whereas the number of events (deaths from melanoma) was `n.event = 45`. The estimated survival probability (at month 2166) for individual 1 was found to be `survival1 = 0.596`, compared to `survival2 = 0.671` for individual 2. The intuition was extended to a random selection of 100 individuals, holding varied values of given predictors. Survival curves for 10 or 100 random individuals resembled downward slopes, indicating decreases in survival probabilities from melanoma with respect to time. Curves of steeper decrease indicate higher risk and hazard, whilst spread among curves reveal strong effects of covariates. 

```{r echo = FALSE, message = FALSE, results='hide'}
coxfit3 <- coxph(Surv(time = Melanoma_df_cleaned$time, 
                   event = Melanoma_df_cleaned$status) ~ sex + ulcer + age + thickness, 
                 method = "breslow", data = Melanoma_df_cleaned)
coxfit3 <- coxph(Surv(time, status) ~ sex + ulcer + age + thickness, 
                 data = Melanoma_df_cleaned)
pred_dat <- data.frame(sex = c(0, 1), ulcer = c(1, 0), age = c(35, 52), thickness = c(4.5, 6.1))
surv_obj <- survfit(coxfit3, newdata = pred_dat)
```

```{r echo = FALSE, message = FALSE, results='hide'}
set.seed(123)
pred_dat2 <- data.frame(
  sex = sample(0:1, 100, replace = TRUE),         
  ulcer = sample(0:1, 100, replace = TRUE),     
  age = round(runif(100, 20, 80)),                
  thickness = round(runif(100, 0.5, 10.0), 1)     
)
surv_obj <- survfit(coxfit3, newdata = pred_dat2)
surv_summary_final <- summary(surv_obj, times = 2166)
surv_probs_final <- surv_summary_final$surv
pred_dat2$survivalprobability <- as.numeric(t(surv_probs_final))
pred_dat2$surv_2166 <- NULL
```

\newpage

```{r echo = FALSE, message = FALSE, fig.width = 6, fig.height = 4}
subset_fit <- survfit(coxfit3, newdata = pred_dat2[1:10, ])
plot(subset_fit, col = 1:10, lty = 1:10,
     xlab = "Time (Months)", ylab = "Survival Probability",
     main = "Figure 7: Survival Curves for 10 Individuals",
     cex.main = 0.8,      
     cex.lab = 0.7,
     cex.axis = 0.6    
)
abline(v = 2166, col = "blue", lty = 2)
```

```{r echo = FALSE, message = FALSE, fig.width = 6, fig.height = 4}
fit_complete <- survfit(coxfit3, newdata = pred_dat2)
plot(fit_complete, col = rainbow(100), lty = 1, xlab = "Time (Months)", ylab = "Survival Probability",
     main = "Figure 8: Survival Curves for 100 Individuals",
     cex.main = 0.8,      
     cex.lab = 0.7,
     cex.axis = 0.6    
)
abline(v = 2166, col = "blue", lty = 2)
```

\newpage

## 5. Limitations & Recommendations

There are limitations of this analysis. First, the Schoenfeld Residuals Test revealed one variable violation of the proportional hazards assumption, meaning that a stratified version of the Cox PH model could be beneficial. Here, stratification could be applied according to `thickness`, which lets the baseline hazard function differ across levels of this variable, and removes the need for proportional hazards. Here, one would forfeit the privilege of estimating the coefficient for `thickness`, obtaining the stratified Cox PH model:
$$h(t \mid \mathbf{x}) = h_{0s}(t) \exp(\boldsymbol{\beta}^T \mathbf{x})$$

```{r}
stratifiedfit <- coxph(Surv(time = Melanoma_df_cleaned$time, 
                   event = Melanoma_df_cleaned$status) ~ sex + ulcer + age + strata(thickness), 
              data = Melanoma_df_cleaned)
```

The above can be generalised to having strata-specific effects for a number of adjusted variables, by including interactions between these variables and the stratifying variable. In addition, if one desired to retain `thickness`, perhaps due to medical implications, the variable could be transformed into a categorical one, with pre-defined ranges.

Furthermore, one could use the Kaplan-Meier estimate, if one required a non-parametric method to estimate survival probabilities without controlling for other factors. Indeed, the Cox proportional hazards model is suitable for analysing relationships between multiple predictors whilst accounting for other covariates. However, to isolate the effects of one variable, a Kaplan-Meier approach could be more effective. The estimation process for the Kaplan-Meier curve can be conducted at each event time $t$ (but not censoring times), where estimates at each point are given by:

$$\hat{S}(t) = \left( 1 - \frac{d(t)}{n(t)} \right) \times \hat{S}(\text{Previous Event Time})$$

## 6. Conclusion

To conclude, this research leveraged R's `Melanoma_df` dataset from the `MedDataSets` package, to assess whether survival probabilities from malignant melanoma decrease over time. After conducting exploratory data analysis and pre-processing, three Cox proportional hazard regression models were fitted and evaluated, rendering the choice to include all predictors (apart from `year`). Two log-rank tests confirmed significant differences in survival experiences between males and females plus those with or without ulceration. By deploying the chosen Cox PH model, survival probabilities for 100 simulated individuals were computed, where visualisations uncovered a decreasing trend over time. Despite the global p-value for the Schoenfeld Residuals Test supporting the proportional hazards assumption, `thickness` led to a violation. Hence, in such situations, one could consider stratification as a method of improving reliability and decreasing bias. Overall, by using a rigorous model selection process and meeting proportional hazard assumptions, one can predict survival probabilities through Cox PH models, for other hazardous health events.  

\newpage

## 7. References

Balch, C.M. et al. (2005) ‘Final Version of the American Joint Committee on Cancer Staging System for Cutaneous Melanoma’, Journal of Clinical Oncology, 23(36), pp. 9039–9048. https://doi.org/10.1200/jco.2005.11.999

Francken, A.B. et al. (2024) ‘Development and Validation of a Clinical Prediction Model for Survival in Cutaneous Melanoma’, JAMA Network Open, 7(1), e245045. https://doi.org/10.1001/jamanetworkopen.2024.5045

Taslimi, S. et al. (2023) ‘International Validation of the American Joint Committee on Cancer Eighth Edition Cutaneous Melanoma Staging System’, British Journal of Dermatology. https://doi.org/10.1093/bjd/ljaf136

Thompson, J.F. et al. (2011) ‘Prognostic Significance of Mitotic Rate in Localized Primary Cutaneous Melanoma: An Analysis of Patients in the AJCC Melanoma Staging Database’, Journal of the American Academy of Dermatology, 65(5), pp. 979–986. https://doi.org/10.1016/j.jaad.2011.06.031
